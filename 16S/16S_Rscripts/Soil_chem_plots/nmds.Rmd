---
title: "Untitled"
author: "Kya Sparks"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(vegan)
library(ggplot2)
library(reshape2)
library(phyloseq)
```


```{r}
# Import your metadata
metadata <- read.csv("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/Soil_Chemistry_TimFegelRMRS/SoilChemAnalysis_16S_ASCC/ASCC_16S_SoilChemMetadata_rem.csv",row.names = 1)

# Import feature table
otus <- read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/ASCC_16S_feature_table_rem_EDIT.txt",row.names = 1)
```

```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus),row.names(metadata)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
otus_5<- otus %>% 
  select(contains("_1C_5"))

meta_5 <- metadata %>% 
  filter(Depth=="0_5cm")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_5),row.names(meta_5)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_5)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_5),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_5)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Full_name_old),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_0-5cm.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_0-5cm.txt', quote = FALSE, sep = '/t')
```





```{r}
otus_SF<- otus %>% 
  select(contains("_SF_"))

meta_SF <- metadata %>% 
  filter(Full_name_old=="SF")
```



```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_SF),row.names(meta_SF)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_SF)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_SF),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_SF)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Depth),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_SF.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_SF.txt', quote = FALSE, sep = '/t')
```















```{r}
otus_SF5<- otus %>% 
  select(contains("_SF_1C_5"))

meta_SF5 <- metadata %>% 
  filter(Full_name_old=="SF") %>% 
  filter(Depth=="0_5cm")
```



```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_SF5),row.names(meta_SF5)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_SF5)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_SF5),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_SF5)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Depth),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectorsSF5.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_SF5.txt', quote = FALSE, sep = '/t')
```









```{r}
otus_15<- otus %>% 
  select(contains("_1C_15"))

meta_15 <- metadata %>% 
  filter(Depth=="5_15cm")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_15),row.names(meta_15)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_15)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_15),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_15)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Full_name_old),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_15cm.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_15cm.txt', quote = FALSE, sep = '/t')
```















```{r}
otus_OM<- otus %>% 
  select(contains("_1C_OM"))

meta_OM <- metadata %>% 
  filter(Depth=="OM") 
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_OM),row.names(meta_OM)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_OM)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_OM),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_OM)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```















```{r}
otus_SF15<- otus %>% 
  select(contains("_SF_1C_15"))

meta_SF15 <- metadata %>% 
  filter(Depth=="5_15cm") %>% 
  filter(Full_name_old=="SF")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_SF15),row.names(meta_SF15)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_SF15)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_SF15),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_SF15)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Full_name_old),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_SF15.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_SF15.txt', quote = FALSE, sep = '/t')
```

























```{r}
otus_SFOM<- otus %>% 
  select(contains("_SF_1C_OM"))

meta_SFOM <- metadata %>% 
  filter(Depth=="OM") %>% 
  filter(Full_name_old=="SF")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_SFOM),row.names(meta_SFOM)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_SFOM)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_SFOM),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_SFOM)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Full_name_old),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_SFOM.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_SFOM.txt', quote = FALSE, sep = '/t')
```















```{r}
otus_TP<- otus %>% 
  select(contains("_TP_1C"))

meta_TP <- metadata %>% 
  filter(Full_name_old=="TP")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_TP),row.names(meta_TP)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_TP)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_TP),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_TP)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```



# Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```





# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Depth),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_TP.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_TP.txt', quote = FALSE, sep = '/t')
```













```{r}
otus_SJ<- otus %>% 
  select(contains("_SJ_1C"))

meta_SJ <- metadata %>% 
  filter(Full_name_old=="SJ")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_SJ),row.names(meta_SJ)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_SJ)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_SJ),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_SJ)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Depth),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_SJ.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_SJ.txt', quote = FALSE, sep = '/t')
```













```{r}
otus_TP5<- otus %>% 
  select(contains("_TP_1C_5"))

meta_TP5 <- metadata %>% 
  filter(Full_name_old=="TP") %>% 
  filter(Depth=="0_5cm")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_TP5),row.names(meta_TP5)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_TP5)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_TP5),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_TP5)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Full_name_old),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_TP5.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_TP5.txt', quote = FALSE, sep = '/t')
```















```{r}
otus_TP15<- otus %>% 
  select(contains("_TP_1C_15"))

meta_TP15 <- metadata %>% 
  filter(Full_name_old=="TP") %>% 
  filter(Depth=="5_15cm")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_TP15),row.names(meta_TP15)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_TP15)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_TP15),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_TP15)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Full_name_old),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_TP15.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_TP15.txt', quote = FALSE, sep = '/t')
```













```{r}
otus_TPOM<- otus %>% 
  select(contains("_TP_1C_OM"))

meta_TPOM <- metadata %>% 
  filter(Full_name_old=="TP") %>% 
  filter(Depth=="OM")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_TPOM),row.names(meta_TPOM)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_TPOM)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_TPOM),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_TPOM)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Full_name_old),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_TPOM.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_TPOM.txt', quote = FALSE, sep = '/t')
```














```{r}
otus_SJ5<- otus %>% 
  select(contains("_SJ_1C_5"))

meta_SJ5 <- metadata %>% 
  filter(Full_name_old=="SJ") %>% 
  filter(Depth=="5")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_SJ5),row.names(meta_SJ5)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_SJ5)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_SJ5),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_SJ5)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Full_name_old),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_SJ5.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_SJ5.txt', quote = FALSE, sep = '/t')
```
















```{r}
otus_SJ15<- otus %>% 
  select(contains("_SJ_1C_15"))

meta_SJ15 <- metadata %>% 
  filter(Full_name_old=="SJ") %>% 
  filter(Depth=="0_5cm")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_SJ15),row.names(meta_SJ15)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_SJ15)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_SJ15),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_SJ15)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Full_name_old),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_SJ15.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_SJ15.txt', quote = FALSE, sep = '/t')
```









```{r}
otus_SJOM<- otus %>% 
  select(contains("_SJ_1C_OM"))

meta_SJOM <- metadata %>% 
  filter(Full_name_old=="SJ") %>% 
  filter(Depth=="OM")
```


```{r}
# check that the names match - they must be in the same order! If all works the result of this line will read 'TRUE' 
all.equal(names(otus_SJOM),row.names(meta_SJOM)) #check to make sure row names and column names equal (aka the sample names), if this reads 'TRUE' you are good to move on!
```



```{r}
# now we need to re-arrange the files, read in taxa, and make sure everything aligns before downstream steps, and make the phyloseq object
otumat<-as.matrix(otus_SJOM)
OTU = otu_table(otumat, taxa_are_rows = TRUE)
taxa<-read.delim("/Users/kyasparks/Desktop/Desktop - MacBook Pro (2)/Kyas_PhD/CSU_2023_2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_taxonomy/filtered/ASCC_16S_taxonomy_forprocessing_copy.txt",row.names=1) #this is a list of the ASV ids and the corresponding taxa strings
taxmat<-as.matrix(taxa)
all.equal(row.names(taxmat),row.names(otumat)) # again - check to make sure they are in the same order!
TAX = tax_table(taxmat)
physeq<-phyloseq(OTU,TAX) #make your phyloseq object, which is basically just a R object that has all of your data for the analyses stored into it
all.equal(row.names(meta_SJOM),sample_names(physeq)) # Final check to make sure everything lines up
sampledata<-sample_data(meta_SJOM)
mgd<-merge_phyloseq(physeq,sampledata) #make the final phyloseq object
```


# Calculate relative abundance from ASV count data - dont need to run this step if you have already done so but it shouldnt really effect! 
```{r}
mgd_relabund<-transform_sample_counts(mgd,function(x)x/sum(x)) #Calculate relative abundance from ASV count data - this is what you can save and use for other taxonomy analyses. If you're interested in doing these, let me know and i can help out!
```

# Calculate Bray-Curtis dissimilary (distance) 
```{r}
mgd_relabund.bray<-distance(mgd_relabund,"bray") 
```


# Final line to generate NMDS ordination 
```{r}
mgd_relabund.bray.nmds<-ordinate(mgd_relabund,"NMDS",mgd_relabund.bray) #WAHOO DO NMDS!!
```

# Use this to read out the NMDS stress (you generally want the stress to be below 0.2)
```{r}
mgd_relabund.bray.nmds$stress 
# stress = 0.1441404
```

#Create plain data frame 'map' of sample metadata

```{r}
mgd_relabund_map=as(sample_data(mgd_relabund),"data.frame") 
sample_tab<-mgd_relabund_map
```


# # Add NMDS coordinates (scores) to the sample table
```{r}
sample_tab$NMDS1<-scores(mgd_relabund.bray.nmds$points)[,1] 
sample_tab$NMDS2<-scores(mgd_relabund.bray.nmds$points)[,2]
```




```{r}
# First, some data checks
env_data = as.data.frame(sample_tab[, -c((ncol(sample_tab) - 1), ncol(sample_tab))])


# Assigning your data (sample_tab file with metadata) a new variable name 

all.equal(row.names(sample_tab), row.names(env_data)) 
# Just checking all is aligned

# Run envfit
fit = envfit(mgd_relabund.bray.nmds, env_data, perm = 10000, na.rm=TRUE) 

# Function envfit finds vectors or factor averages of environmental variables/metadata

fit.scrs = as.data.frame(scores(fit, display = "vectors")) 

# Add those scores as vectors to the plot

fit.scrs <- cbind(fit.scrs, Soil_Chem = rownames(fit.scrs)) 

# Adding this info to the matrix 'fit.scrs'

# This is your ggplot code from your normal NMDS - adjust as needed so yours looks similar
# Note here we are assigning the plot as 'p' - so it will not show the plot until you run line 20 below which is just 'p'

p = ggplot(data=sample_tab, aes(x = NMDS1, y = NMDS2)) + 
  geom_point(aes(color=Depth),alpha=.75) +
  theme_classic()   
p

# ADD VECTORS TO THE PLOT
# Now we are telling ggplot to add more 'stuff' to the plot - the envfit information 
# So we say our 'p' is the old plot + new stuff (everything after geom_segment)  
# Again, we run 'p' to see what this has added, hopefully vectors! 
p = p +
  geom_segment(data = fit.scrs, aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2), 
               arrow = arrow(length = unit(0.25, "cm")), arrow.fill = "black")

p

# LABEL VECTORS
# Again, we are building off the previous plots (as saved by 'p')
# This time the ordination should be updated to have vectors that are labeled 

p = p + 
  geom_text(data = fit.scrs, aes(x = NMDS1 * 1.1, y = NMDS2 * 1.1, label = Soil_Chem), size = 2) 
p

# Save the ordination + vectors 
ggsave("NMDS-with-vectors_SJOM.pdf")

# The following commands will list which variables have a significant p value (first line), 
# show the p-values (second line), and then show all data (third line)
which(fit$vectors$pvals <= 0.05)
fit$vectors$pvals
fit$vectors

# Write the p-values for the variables to a .csv file and save it in your working directory
write.table(fit$vectors$pvals, file = 'pvals_vectors_SJOM.txt', quote = FALSE, sep = '/t')
```








