## Heatmaps


# 16S


```{r}
library(tidyverse)
library(ggplot2)
library(grid)
library(dplyr)
library(vegan)
library(Hmisc)
library(readxl)
library(stringr)
library(cowplot)
library(patchwork)
library(ggtext)
```


```{r}
custom_colors6 <- c("#F5F0DA", "#B75347")
custom_colors_seq <- c("#FFFFFF", "#EDE955", "#DE6000", "#6D2F20")

# Custom warm palette (user-defined)
custom_warm_palette <- c(
  "#FFFFFF",  # 0 - true white
  "#FEF6B5",  # ~1
  "#FFE9A0",  # ~2
  "#FFD085",  # ~3
  "#FFA679",  # ~5
  "#FA8A76",  # ~8
  "#E15383"   # ~15
)

# Final Hokusai-inspired gradient
custom_hokusai_gradient <- c(
  "#FFFFFF",   # White for 0 (overridden below)
  "#F6E3A1",   # Soft yellow
  "#DE6000",   # Rich orange
  "#B75347",   # Coral/clay
  "#DE7666"    # Dusty pink
)

# Step 1: Load and label each depth
maaslin_sf_5 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "shallow_sf") %>%
  mutate(Depth = "0-5cm")

maaslin_sf_15 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "deep_sf") %>%
  mutate(Depth = "5-15cm")

maaslin_sf_OM <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "OM_sf") %>%
  mutate(Depth = "OM")

# Step 2: Combine and clean taxonomy
maaslin_all <- bind_rows(maaslin_sf_5, maaslin_sf_15, maaslin_sf_OM) %>%
  separate(taxonomy, into = c("Domain", "Phyla", "Class", "Order", "Family", "Genus", "Species"), sep = ";") %>%
  mutate(across(c(Phyla, Domain, Class, Order, Family, Genus, Species),
                ~str_remove_all(.x, "^[a-z]__") %>% str_trim())) %>%
  filter(!is.na(Phyla), Phyla != "", !str_detect(Phyla, "^\\s*$"), !str_detect(Phyla, "^p__$"))

write.csv(maaslin_all, "/Users/kyasparks/Desktop/CSU 2023-2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/Maaslinall_sf.csv", row.names = FALSE)

# Step 3: Filter to significant OTUs only
maaslin_sig <- maaslin_all %>% filter(qval < 0.05)

# Step 4: Split by direction and summarize separately
sf_enriched <- maaslin_sig %>%
  filter(coef > 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(mean_coef = mean(coef), mean_qval = mean(qval), n_OTUs = n_distinct(OTUID), .groups = "drop")

other_enriched <- maaslin_sig %>%
  filter(coef < 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(mean_coef = mean(coef), mean_qval = mean(qval), n_OTUs = n_distinct(OTUID), .groups = "drop") %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0))

# Step 5: Combine enriched sets
heatmap_data <- bind_rows(sf_enriched, other_enriched) %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0)) %>%
  group_by(Phyla, Depth) %>%
  slice_max(order_by = abs(mean_coef), n = 1, with_ties = FALSE) %>%
  ungroup()

# Step 6: Label and reorder
heatmap_data <- heatmap_data %>%
  mutate(
    label = as.character(n_OTUs),
    total_OTUs = ave(n_OTUs, Phyla, FUN = sum),
    Phyla = forcats::fct_reorder(Phyla, total_OTUs, .desc = FALSE),
    fill_val = ifelse(n_OTUs == 0, NA, n_OTUs)  # NA for 0s
  )

# Step 7: Plot
heatmap_plot <- ggplot(heatmap_data, aes(x = Depth, y = Phyla)) +
  geom_tile(aes(fill = fill_val), color = "white") +
  geom_text(aes(label = label), color = "black", size = 3.5) +
  scale_fill_gradientn(
    colors = custom_hokusai_gradient,
    values = scales::rescale(c(0, 2, 5, 10, 15)),
    limits = c(0, max(heatmap_data$n_OTUs, na.rm = TRUE)),
    name = "# of Discriminant OTUs",
    na.value = "#A9A9A9",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(5, "cm")
    )
  ) +
  theme_minimal() +
  labs(
    title = "Number of Discriminant OTUs (SF vs Other)",
    x = "Depth",
    y = "Phylum"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "right"
  )

# Extract and stack legend
heatmap_nolegend <- heatmap_plot + theme(legend.position = "none")
legend <- cowplot::get_legend(heatmap_plot)
legend_plot <- cowplot::ggdraw(legend)

legend_stack <- legend_plot

# Final plot assembly
final_plot1 <- heatmap_nolegend | legend_stack +
  plot_layout(widths = c(5, 1)) &
  theme(plot.margin = margin(5, 5, 5, 5))

# Render final plot
final_plot1

sf_data <- heatmap_data
```

```{r}
custom_colors6 <- c("#F5F0DA", "#B75347")
custom_colors_seq <- c("#FFFFFF", "#EDE955", "#DE6000", "#6D2F20")

# Custom warm palette (user-defined)
custom_warm_palette <- c(
  "#FFFFFF",  # 0 - true white
  "#FEF6B5",  # ~1
  "#FFE9A0",  # ~2
  "#FFD085",  # ~3
  "#FFA679",  # ~5
  "#FA8A76",  # ~8
  "#E15383"   # ~15
)

# Final Hokusai-inspired gradient
custom_hokusai_gradient <- c(
  "#FFFFFF",   # White for 0 (overridden below)
  "#F6E3A1",   # Soft yellow
  "#DE6000",   # Rich orange
  "#B75347",   # Coral/clay
  "#DE7666"    # Dusty pink
)

# Step 1: Load and label each depth
maaslin_sf_5 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "shallow_sf") %>%
  mutate(Depth = "0-5cm")

maaslin_sf_15 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "deep_sf") %>%
  mutate(Depth = "5-15cm")

maaslin_sf_OM <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "OM_sf") %>%
  mutate(Depth = "OM")

# Step 2: Combine and clean taxonomy
maaslin_all <- bind_rows(maaslin_sf_5, maaslin_sf_15, maaslin_sf_OM) %>%
  separate(taxonomy, into = c("Domain", "Phyla", "Class", "Order", "Family", "Genus", "Species"), sep = ";") %>%
  mutate(across(c(Phyla, Domain, Class, Order, Family, Genus, Species),
                ~str_remove_all(.x, "^[a-z]__") %>% str_trim())) %>%
  filter(!is.na(Phyla), Phyla != "", !str_detect(Phyla, "^\\s*$"), !str_detect(Phyla, "^p__$"))

write.csv(maaslin_all, "/Users/kyasparks/Desktop/CSU 2023-2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/Maaslinall_sf.csv", row.names = FALSE)

# Step 3: Filter to significant OTUs only
maaslin_sig <- maaslin_all %>% filter(qval < 0.05)

# Step 4: Split by direction and summarize separately
sf_enriched <- maaslin_sig %>%
  filter(coef > 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(mean_coef = mean(coef), mean_qval = mean(qval), n_OTUs = n_distinct(OTUID), .groups = "drop")

other_enriched <- maaslin_sig %>%
  filter(coef < 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(mean_coef = mean(coef), mean_qval = mean(qval), n_OTUs = n_distinct(OTUID), .groups = "drop") %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0))

# Step 5: Combine enriched sets
heatmap_data <- bind_rows(sf_enriched, other_enriched) %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0)) %>%
  group_by(Phyla, Depth) %>%
  slice_max(order_by = abs(mean_coef), n = 1, with_ties = FALSE) %>%
  ungroup()

# Step 6: Label and reorder
heatmap_data <- heatmap_data %>%
  mutate(
    label = as.character(n_OTUs),
    total_OTUs = ave(n_OTUs, Phyla, FUN = sum),
    Phyla = forcats::fct_reorder(Phyla, total_OTUs, .desc = FALSE),
    fill_val = ifelse(n_OTUs == 0, NA, n_OTUs)  # NA for 0s
  )

# Step 7: Plot
heatmap_plot <- ggplot(heatmap_data, aes(x = Depth, y = Phyla)) +
  geom_tile(aes(fill = fill_val), color = "white") +
  geom_text(aes(label = label), color = "black", size = 3.5) +
  scale_fill_gradientn(
    colors = custom_hokusai_gradient,
    values = scales::rescale(c(0, 2, 5, 10, 15)),
    limits = c(0, max(heatmap_data$n_OTUs, na.rm = TRUE)),
    name = "# of Discriminant OTUs",
    na.value = "black",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(5, "cm")
    )
  ) +
  theme_minimal() +
  labs(
    title = "Number of Discriminant OTUs (SF vs Other)",
    x = "Depth",
    y = "Phylum"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "right"
  )

# Extract and stack legend
heatmap_nolegend <- heatmap_plot + theme(legend.position = "none")
legend <- cowplot::get_legend(heatmap_plot)
legend_plot <- cowplot::ggdraw(legend)

legend_stack <- legend_plot

# Final plot assembly
final_plot1 <- heatmap_nolegend | legend_stack +
  plot_layout(widths = c(5, 1)) &
  theme(plot.margin = margin(5, 5, 5, 5))

# Render final plot
final_plot1
```



























```{r}
custom_colors6 <- c("#F5F0DA", "#B75347")
custom_colors_seq <- c("#FFFFFF", "#EDE955", "#DE6000", "#6D2F20")

# Custom warm palette (user-defined)
custom_warm_palette <- c(
  "#FFFFFF",  # 0 - true white
  "#FEF6B5",  # ~1
  "#FFE9A0",  # ~2
  "#FFD085",  # ~3
  "#FFA679",  # ~5
  "#FA8A76",  # ~8
  "#E15383"   # ~15
)

# Final Hokusai-inspired gradient
custom_hokusai_gradient <- c(
  "#FFFFFF",   # White for 0 (overridden below)
  "#F6E3A1",   # Soft yellow
  "#DE6000",   # Rich orange
  "#B75347",   # Coral/clay
  "#DE7666"    # Dusty pink
)

# Step 1: Load and label each depth
maaslin_tp_5 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "shallow_tp") %>%
  mutate(Depth = "0-5cm")

maaslin_tp_15 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "deep_tp") %>%
  mutate(Depth = "5-15cm")

maaslin_tp_OM <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "OM_tp") %>%
  mutate(Depth = "OM")

# Step 2: Combine and clean taxonomy
maaslin_all <- bind_rows(maaslin_tp_5, maaslin_tp_15, maaslin_tp_OM) %>%
  separate(taxonomy, into = c("Domain", "Phyla", "Class", "Order", "Family", "Genus", "Species"), sep = ";") %>%
  mutate(across(c(Phyla, Domain, Class, Order, Family, Genus, Species),
                ~str_remove_all(.x, "^[a-z]__") %>% str_trim())) %>%
  filter(!is.na(Phyla), Phyla != "", !str_detect(Phyla, "^\\s*$"), !str_detect(Phyla, "^p__$"))

write.csv(maaslin_all, "/Users/kyasparks/Desktop/CSU 2023-2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/Maaslinall_tp.csv", row.names = FALSE)

# Step 3: Filter to significant OTUs only
maaslin_sig <- maaslin_all %>% filter(qval < 0.05)

# Step 4: Split by direction and summarize separately
tp_enriched <- maaslin_sig %>%
  filter(coef > 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(mean_coef = mean(coef), mean_qval = mean(qval), n_OTUs = n_distinct(OTUID), .groups = "drop")

other_enriched <- maaslin_sig %>%
  filter(coef < 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(mean_coef = mean(coef), mean_qval = mean(qval), n_OTUs = n_distinct(OTUID), .groups = "drop") %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0))

# Step 5: Combine enriched sets and keep one value per Phyla × Depth
heatmap_data <- bind_rows(tp_enriched, other_enriched) %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0)) %>%
  group_by(Phyla, Depth) %>%
  slice_max(order_by = abs(mean_coef), n = 1, with_ties = FALSE) %>%
  ungroup()

# Step 6: Add a label with OTU count + significance
heatmap_data <- heatmap_data %>%
  mutate(
    label = as.character(n_OTUs),
    total_OTUs = ave(n_OTUs, Phyla, FUN = sum),
    Phyla = forcats::fct_reorder(Phyla, total_OTUs, .desc = FALSE),
    fill_val = ifelse(n_OTUs == 0, NA, n_OTUs)  # NA for 0s
  )


heatmap_plot <- ggplot(heatmap_data, aes(x = Depth, y = Phyla)) +
 geom_tile(aes(fill = fill_val), color = "white") +
  geom_text(aes(label = label), color = "black", size = 3.5) +
  scale_fill_gradientn(
    colors = custom_hokusai_gradient,
    values = scales::rescale(c(0, 2, 5, 10, 15)),
    limits = c(0, max(heatmap_data$n_OTUs, na.rm = TRUE)),
    name = "# of Discriminant OTUs",
    na.value = "#A9A9A9",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(5, "cm"))) +
  theme_minimal() +
  labs(
    title = "Number of Discriminant OTUs (TP vs Other)",
    x = "Depth",
    y = "Phylum"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "right"
  )

# Step 1: Remove legend from main plot
heatmap_nolegend <- heatmap_plot + theme(legend.position = "none")

# Step 2: Extract legend grob
legend <- cowplot::get_legend(heatmap_plot)

# Step 3: Convert legend into ggplot object
legend_plot <- cowplot::ggdraw(legend)
legend_stack <- legend_plot
# Step 4: Asterisk significance legend, positioned below the gradient legend

# Step 6: Combine heatmap and right-side legend stack
final_plot2 <- heatmap_nolegend | legend_stack +
  plot_layout(widths = c(5, 1)) 
  theme(plot.margin = margin(5, 5, 5, 5)) Adjust widths to control layout proportions
# Tighten all margin
  
# Step 7: Render final combined plot
final_plot2
tp_data <- heatmap_data
```

```{r}
custom_colors6 <- c("#F5F0DA", "#B75347")
custom_colors_seq <- c("#FFFFFF", "#EDE955", "#DE6000", "#6D2F20")

# Custom warm palette (user-defined)
custom_warm_palette <- c(
  "#FFFFFF",  # 0 - true white
  "#FEF6B5",  # ~1
  "#FFE9A0",  # ~2
  "#FFD085",  # ~3
  "#FFA679",  # ~5
  "#FA8A76",  # ~8
  "#E15383"   # ~15
)

# Final Hokusai-inspired gradient
custom_hokusai_gradient <- c(
  "#FFFFFF",   # White for 0 (overridden below)
  "#F6E3A1",   # Soft yellow
  "#DE6000",   # Rich orange
  "#B75347",   # Coral/clay
  "#DE7666"    # Dusty pink
)

# Step 1: Load and label each depth
maaslin_tp_5 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "shallow_tp") %>%
  mutate(Depth = "0-5cm")

maaslin_tp_15 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "deep_tp") %>%
  mutate(Depth = "5-15cm")

maaslin_tp_OM <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "OM_tp") %>%
  mutate(Depth = "OM")

# Step 2: Combine and clean taxonomy
maaslin_all <- bind_rows(maaslin_tp_5, maaslin_tp_15, maaslin_tp_OM) %>%
  separate(taxonomy, into = c("Domain", "Phyla", "Class", "Order", "Family", "Genus", "Species"), sep = ";") %>%
  mutate(across(c(Phyla, Domain, Class, Order, Family, Genus, Species),
                ~str_remove_all(.x, "^[a-z]__") %>% str_trim())) %>%
  filter(!is.na(Phyla), Phyla != "", !str_detect(Phyla, "^\\s*$"), !str_detect(Phyla, "^p__$"))

write.csv(maaslin_all, "/Users/kyasparks/Desktop/CSU 2023-2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/Maaslinall_tp.csv", row.names = FALSE)

# Step 3: Filter to significant OTUs only
maaslin_sig <- maaslin_all %>% filter(qval < 0.05)

# Step 4: Split by direction and summarize separately
tp_enriched <- maaslin_sig %>%
  filter(coef > 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(mean_coef = mean(coef), mean_qval = mean(qval), n_OTUs = n_distinct(OTUID), .groups = "drop")

other_enriched <- maaslin_sig %>%
  filter(coef < 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(mean_coef = mean(coef), mean_qval = mean(qval), n_OTUs = n_distinct(OTUID), .groups = "drop") %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0))

# Step 5: Combine enriched sets and keep one value per Phyla × Depth
heatmap_data <- bind_rows(tp_enriched, other_enriched) %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0)) %>%
  group_by(Phyla, Depth) %>%
  slice_max(order_by = abs(mean_coef), n = 1, with_ties = FALSE) %>%
  ungroup()

# Step 6: Add a label with OTU count + significance
heatmap_data <- heatmap_data %>%
  mutate(
    label = as.character(n_OTUs),
    total_OTUs = ave(n_OTUs, Phyla, FUN = sum),
    Phyla = forcats::fct_reorder(Phyla, total_OTUs, .desc = FALSE),
    fill_val = ifelse(n_OTUs == 0, NA, n_OTUs)  # NA for 0s
  )


heatmap_plot <- ggplot(heatmap_data, aes(x = Depth, y = Phyla)) +
 geom_tile(aes(fill = fill_val), color = "white") +
  geom_text(aes(label = label), color = "black", size = 3.5) +
  scale_fill_gradientn(
    colors = custom_hokusai_gradient,
    values = scales::rescale(c(0, 2, 5, 10, 15)),
    limits = c(0, max(heatmap_data$n_OTUs, na.rm = TRUE)),
    name = "# of Discriminant OTUs",
    na.value = "black",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(5, "cm"))) +
  theme_minimal() +
  labs(
    title = "Number of Discriminant OTUs (TP vs Other)",
    x = "Depth",
    y = "Phylum"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "right"
  )

# Step 1: Remove legend from main plot
heatmap_nolegend <- heatmap_plot + theme(legend.position = "none")

# Step 2: Extract legend grob
legend <- cowplot::get_legend(heatmap_plot)

# Step 3: Convert legend into ggplot object
legend_plot <- cowplot::ggdraw(legend)
legend_stack <- legend_plot
# Step 4: Asterisk significance legend, positioned below the gradient legend

# Step 6: Combine heatmap and right-side legend stack
final_plot2 <- heatmap_nolegend | legend_stack +
  plot_layout(widths = c(5, 1)) 
  theme(plot.margin = margin(5, 5, 5, 5)) Adjust widths to control layout proportions
# Tighten all margin
  
# Step 7: Render final combined plot
final_plot2
```






















```{r}
custom_colors6 <- c("#F5F0DA", "#B75347")
custom_colors_seq <- c("#FFFFFF", "#EDE955", "#DE6000", "#6D2F20")

# Custom warm palette (user-defined)
custom_warm_palette <- c(
  "#FFFFFF",  # 0 - true white
  "#FEF6B5",  # ~1
  "#FFE9A0",  # ~2
  "#FFD085",  # ~3
  "#FFA679",  # ~5
  "#FA8A76",  # ~8
  "#E15383"   # ~15
)

# Final Hokusai-inspired gradient
custom_hokusai_gradient <- c(
  "#FFFFFF",   # White for 0 (overridden below)
  "#F6E3A1",   # Soft yellow
  "#DE6000",   # Rich orange
  "#B75347",   # Coral/clay
  "#DE7666"    # Dusty pink
)

# Step 1: Load and label each depth
maaslin_sj_5 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "shallow_sj") %>%
  mutate(Depth = "0-5cm")

maaslin_sj_15 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "deep_sj") %>%
  mutate(Depth = "5-15cm")

maaslin_sj_OM <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "OM_sj") %>%
  mutate(Depth = "OM")

# Step 2: Combine and clean taxonomy
maaslin_all <- bind_rows(maaslin_sj_5, maaslin_sj_15, maaslin_sj_OM) %>%
  separate(taxonomy, into = c("Domain", "Phyla", "Class", "Order", "Family", "Genus", "Species"), sep = ";") %>%
  mutate(across(c(Phyla, Domain, Class, Order, Family, Genus, Species),
                ~str_remove_all(.x, "^[a-z]__") %>% str_trim())) %>%
  filter(!is.na(Phyla), Phyla != "", !str_detect(Phyla, "^\\s*$"), !str_detect(Phyla, "^p__$"))

write.csv(maaslin_all, "/Users/kyasparks/Desktop/CSU 2023-2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/Maaslinall_sj.csv", row.names = FALSE)

# Step 3: Filter to significant OTUs only
maaslin_sig <- maaslin_all %>% filter(qval < 0.05)

# Step 4: Split by direction and summarize separately
sj_enriched <- maaslin_sig %>%
  filter(coef > 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(
    mean_coef = mean(coef), 
    mean_qval = mean(qval), 
    n_OTUs = n_distinct(OTUID), 
    .groups = "drop"
  )

other_enriched <- maaslin_sig %>%
  filter(coef < 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(
    mean_coef = mean(coef), 
    mean_qval = mean(qval), 
    n_OTUs = n_distinct(OTUID), 
    .groups = "drop"
  ) %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0))

# Step 5: Combine enriched sets and keep one value per Phyla × Depth
heatmap_data <- bind_rows(sf_enriched, other_enriched) %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0)) %>%
  group_by(Phyla, Depth) %>%
  slice_max(order_by = abs(mean_coef), n = 1, with_ties = FALSE) %>%
  ungroup()

# Step 6: Add a label with OTU count + significance
heatmap_data <- heatmap_data %>%
  mutate(
    label = as.character(n_OTUs),
    total_OTUs = ave(n_OTUs, Phyla, FUN = sum),
    Phyla = forcats::fct_reorder(Phyla, total_OTUs, .desc = FALSE),
    fill_val = ifelse(n_OTUs == 0, NA, n_OTUs)  # NA for 0s
  )

# Step 7: Set color scale

heatmap_plot <- ggplot(heatmap_data, aes(x = Depth, y = Phyla)) +
  geom_tile(aes(fill = fill_val), color = "white") +
  geom_text(aes(label = label), color = "black", size = 3.5) +
  scale_fill_gradientn(
    colors = custom_hokusai_gradient,
    values = scales::rescale(c(0, 2, 5, 10, 15)),
    limits = c(0, max(heatmap_data$n_OTUs, na.rm = TRUE)),
    name = "# of Discriminant OTUs",
    na.value = "#A9A9A9",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(5, "cm")
    )
  ) +
  theme_minimal() +
  labs(
    title = "Number of Discriminant OTUs (SJ vs Other)",
    x = "Depth",
    y = "Phylum"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "right"
  )


# Step 1: Remove legend from main plot
heatmap_nolegend <- heatmap_plot + theme(legend.position = "none")
legend <- cowplot::get_legend(heatmap_plot)
legend_plot <- cowplot::ggdraw(legend)
legend_stack <- legend_plot



# Step 6: Combine heatmap and right-side legend stack
final_plot3 <- heatmap_nolegend | legend_stack +
  plot_layout(widths = c(.1, .5))  # Adjust widths to control layout proportions



final_plot3 <- heatmap_nolegend | legend_stack +
  plot_layout(widths = c(5, 1)) &
  theme(plot.margin = margin(5, 5, 5, 5))
# Step 7: Render final combined plot
final_plot3
sj_data <- heatmap_data
```




```{r}
custom_colors6 <- c("#F5F0DA", "#B75347")
custom_colors_seq <- c("#FFFFFF", "#EDE955", "#DE6000", "#6D2F20")

# Custom warm palette (user-defined)
custom_warm_palette <- c(
  "#FFFFFF",  # 0 - true white
  "#FEF6B5",  # ~1
  "#FFE9A0",  # ~2
  "#FFD085",  # ~3
  "#FFA679",  # ~5
  "#FA8A76",  # ~8
  "#E15383"   # ~15
)

# Final Hokusai-inspired gradient
custom_hokusai_gradient <- c(
  "#FFFFFF",   # White for 0 (overridden below)
  "#F6E3A1",   # Soft yellow
  "#DE6000",   # Rich orange
  "#B75347",   # Coral/clay
  "#DE7666"    # Dusty pink
)

# Step 1: Load and label each depth
maaslin_sj_5 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "shallow_sj") %>%
  mutate(Depth = "0-5cm")

maaslin_sj_15 <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "deep_sj") %>%
  mutate(Depth = "5-15cm")

maaslin_sj_OM <- read_excel("/Users/kyasparks/Desktop/CSU 2023-2028/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/MaaslineResults_CLEANED_with_logQval.xlsx", sheet = "OM_sj") %>%
  mutate(Depth = "OM")

# Step 2: Combine and clean taxonomy
maaslin_all <- bind_rows(maaslin_sj_5, maaslin_sj_15, maaslin_sj_OM) %>%
  separate(taxonomy, into = c("Domain", "Phyla", "Class", "Order", "Family", "Genus", "Species"), sep = ";") %>%
  mutate(across(c(Phyla, Domain, Class, Order, Family, Genus, Species),
                ~str_remove_all(.x, "^[a-z]__") %>% str_trim())) %>%
  filter(!is.na(Phyla), Phyla != "", !str_detect(Phyla, "^\\s*$"), !str_detect(Phyla, "^p__$"))

write.csv(maaslin_all, "/Users/kyasparks/Desktop/CSU 2023-2024/Projects/ASCC/ASCC_July2024_USETHIS_ks/16S/16S_metadata/Maaslinall_sj.csv", row.names = FALSE)

# Step 3: Filter to significant OTUs only
maaslin_sig <- maaslin_all %>% filter(qval < 0.05)

# Step 4: Split by direction and summarize separately
sj_enriched <- maaslin_sig %>%
  filter(coef > 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(
    mean_coef = mean(coef), 
    mean_qval = mean(qval), 
    n_OTUs = n_distinct(OTUID), 
    .groups = "drop"
  )

other_enriched <- maaslin_sig %>%
  filter(coef < 0) %>%
  distinct(OTUID, Phyla, Depth, .keep_all = TRUE) %>%
  group_by(Phyla, Depth) %>%
  summarise(
    mean_coef = mean(coef), 
    mean_qval = mean(qval), 
    n_OTUs = n_distinct(OTUID), 
    .groups = "drop"
  ) %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0))

# Step 5: Combine enriched sets and keep one value per Phyla × Depth
heatmap_data <- bind_rows(sf_enriched, other_enriched) %>%
  complete(Phyla, Depth, fill = list(mean_coef = 0, mean_qval = 1, n_OTUs = 0)) %>%
  group_by(Phyla, Depth) %>%
  slice_max(order_by = abs(mean_coef), n = 1, with_ties = FALSE) %>%
  ungroup()

# Step 6: Add a label with OTU count + significance
heatmap_data <- heatmap_data %>%
  mutate(
    label = as.character(n_OTUs),
    total_OTUs = ave(n_OTUs, Phyla, FUN = sum),
    Phyla = forcats::fct_reorder(Phyla, total_OTUs, .desc = FALSE),
    fill_val = ifelse(n_OTUs == 0, NA, n_OTUs)  # NA for 0s
  )

# Step 7: Set color scale

heatmap_plot <- ggplot(heatmap_data, aes(x = Depth, y = Phyla)) +
  geom_tile(aes(fill = fill_val), color = "white") +
  geom_text(aes(label = label), color = "black", size = 3.5) +
  scale_fill_gradientn(
    colors = custom_hokusai_gradient,
    values = scales::rescale(c(0, 2, 5, 10, 15)),
    limits = c(0, max(heatmap_data$n_OTUs, na.rm = TRUE)),
    name = "# of Discriminant OTUs",
    na.value = "black",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(5, "cm")
    )
  ) +
  theme_minimal() +
  labs(
    title = "Number of Discriminant OTUs (SJ vs Other)",
    x = "Depth",
    y = "Phylum"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "right"
  )


# Step 1: Remove legend from main plot
heatmap_nolegend <- heatmap_plot + theme(legend.position = "none")
legend <- cowplot::get_legend(heatmap_plot)
legend_plot <- cowplot::ggdraw(legend)
legend_stack <- legend_plot



# Step 6: Combine heatmap and right-side legend stack
final_plot3 <- heatmap_nolegend | legend_stack +
  plot_layout(widths = c(.1, .5))  # Adjust widths to control layout proportions



final_plot3 <- heatmap_nolegend | legend_stack +
  plot_layout(widths = c(5, 1)) &
  theme(plot.margin = margin(5, 5, 5, 5))
# Step 7: Render final combined plot
final_plot3
```



```{r}


# Determine full list of unique phyla across all sites
all_phyla <- union(union(levels(droplevels(sf_data$Phyla)), levels(droplevels(tp_data$Phyla))), levels(droplevels(sj_data$Phyla)))

# Ensure all phyla appear in each dataset (even if with zero OTUs)
expand_phylum_grid <- function(data, all_phyla) {
  depths <- unique(data$Depth)
  expanded <- expand.grid(Phyla = all_phyla, Depth = depths, KEEP.OUT.ATTRS = FALSE, stringsAsFactors = FALSE)
  data <- full_join(expanded, data, by = c("Phyla", "Depth"))
  data$Phyla <- factor(data$Phyla, levels = rev(sort(unique(all_phyla))))
  data$fill_val[is.na(data$fill_val)] <- NA
  data$n_OTUs[is.na(data$n_OTUs)] <- 0
  data$label[is.na(data$label)] <- "0"
  return(data)
}

sf_data <- expand_phylum_grid(sf_data, all_phyla)
tp_data <- expand_phylum_grid(tp_data, all_phyla)
sj_data <- expand_phylum_grid(sj_data, all_phyla)


# Create each plot without legends
shared_limits <- c(0, max(c(sf_data$n_OTUs, tp_data$n_OTUs, sj_data$n_OTUs), na.rm = TRUE))

plot_sf <- ggplot(sf_data, aes(x = Depth, y = Phyla)) +
  geom_tile(aes(fill = fill_val), color = "white") +
  geom_text(aes(label = label), color = "black", size = 3.5) +
  scale_fill_gradientn(
    colors = custom_hokusai_gradient,
    values = scales::rescale(c(0, 2, 5, 10, 15)),
    limits = shared_limits,
    name = "# of Discriminant OTUs",
    na.value = "black",
    guide = "none"
  ) +
  labs(title = "SF vs Other", x = "Depth", y = "Phylum") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1), panel.grid = element_blank())

plot_tp <- ggplot(tp_data, aes(x = Depth, y = Phyla)) +
  geom_tile(aes(fill = fill_val), color = "white") +
  geom_text(aes(label = label), color = "black", size = 3.5) +
  scale_fill_gradientn(
    colors = custom_hokusai_gradient,
    values = scales::rescale(c(0, 2, 5, 10, 15)),
    limits = shared_limits,
    name = "# of Discriminant OTUs",
    na.value = "black",
    guide = "none"
  ) +
  labs(title = "TP vs Other", x = "Depth", y = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_blank(), panel.grid = element_blank())

plot_sj <- ggplot(sj_data, aes(x = Depth, y = Phyla)) +
  geom_tile(aes(fill = fill_val), color = "white") +
  geom_text(aes(label = label), color = "black", size = 3.5) +
  scale_fill_gradientn(
    colors = custom_hokusai_gradient,
    values = scales::rescale(c(0, 2, 5, 10, 15)),
    limits = shared_limits,
    name = "# of Discriminant OTUs",
    na.value = "black",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(5, "cm"))
  ) +
  labs(title = "SJ vs Other", x = "Depth", y = NULL) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_blank(), panel.grid = element_blank())

# Extract legend from one plot
shared_legend <- cowplot::get_legend(plot_sj)

# Remove legend from the plot used to extract it
plot_sj <- plot_sj + theme(legend.position = "none")

# Assemble the three plots side-by-side with a single legend
final_combined_plot <- (plot_sf + plot_tp + plot_sj + plot_layout(widths = c(1, 1, 1))) |
  wrap_elements(shared_legend) +
  plot_layout(widths = c(3, 0.3)) &
  theme(plot.margin = margin(5, 5, 5, 5))

# Display the combined plot
final_combined_plot
```